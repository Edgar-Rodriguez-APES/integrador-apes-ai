name: Pre-Deploy Code Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  python-security:
    name: Python Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit pylint flake8
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi
      
      - name: Run Bandit Security Scanner
        run: |
          bandit -r src/lambdas/ -f json -o bandit-report.json || true
          bandit -r src/lambdas/ -f txt
        continue-on-error: true
      
      - name: Run Safety Check (Dependencies)
        run: |
          safety check --json > safety-report.json || true
          safety check
        continue-on-error: true
      
      - name: Run pip-audit
        run: |
          pip-audit --format json > pip-audit-report.json || true
          pip-audit
        continue-on-error: true
      
      - name: Upload Security Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: python-security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit-report.json

  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint flake8 black
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Run Pylint
        run: |
          pylint src/lambdas/ --output-format=json > pylint-report.json || true
          pylint src/lambdas/ --exit-zero
        continue-on-error: true
      
      - name: Run Flake8
        run: |
          flake8 src/lambdas/ --max-line-length=120 --output-file=flake8-report.txt || true
          flake8 src/lambdas/ --max-line-length=120
        continue-on-error: true
      
      - name: Check Black Formatting
        run: |
          black --check src/lambdas/ || true
        continue-on-error: true
      
      - name: Upload Quality Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: python-quality-reports
          path: |
            pylint-report.json
            flake8-report.txt

  typescript-analysis:
    name: TypeScript/CDK Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm ci
      
      - name: Run npm audit
        run: |
          npm audit --json > npm-audit-report.json || true
          npm audit
        continue-on-error: true
      
      - name: Run TypeScript Compiler
        run: |
          npm run build || true
        continue-on-error: true
      
      - name: Run ESLint
        run: |
          npx eslint src/infrastructure/ --ext .ts --format json -o eslint-report.json || true
          npx eslint src/infrastructure/ --ext .ts
        continue-on-error: true
      
      - name: Upload TypeScript Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: typescript-reports
          path: |
            npm-audit-report.json
            eslint-report.json

  cdk-validation:
    name: AWS CDK Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          npm ci
      
      - name: CDK Synth (Validate)
        run: |
          npm run cdk synth > cdk-synth-output.txt 2>&1 || true
        continue-on-error: true
      
      - name: Upload CDK Reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cdk-reports
          path: cdk-synth-output.txt

  summary-report:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [python-security, python-quality, typescript-analysis, cdk-validation]
    if: always()
    steps:
      - uses: actions/checkout@v3
      
      - name: Download all reports
        uses: actions/download-artifact@v3
      
      - name: Create Summary
        run: |
          echo "# ðŸ” Pre-Deploy Analysis Summary" > ANALYSIS-SUMMARY.md
          echo "" >> ANALYSIS-SUMMARY.md
          echo "## Analysis Date: $(date)" >> ANALYSIS-SUMMARY.md
          echo "" >> ANALYSIS-SUMMARY.md
          echo "### âœ… Completed Checks:" >> ANALYSIS-SUMMARY.md
          echo "- Python Security (Bandit, Safety, pip-audit)" >> ANALYSIS-SUMMARY.md
          echo "- Python Code Quality (Pylint, Flake8)" >> ANALYSIS-SUMMARY.md
          echo "- TypeScript Analysis (ESLint, npm audit)" >> ANALYSIS-SUMMARY.md
          echo "- AWS CDK Validation" >> ANALYSIS-SUMMARY.md
          echo "" >> ANALYSIS-SUMMARY.md
          echo "### ðŸ“Š Reports Available:" >> ANALYSIS-SUMMARY.md
          echo "Check the artifacts section for detailed reports" >> ANALYSIS-SUMMARY.md
      
      - name: Upload Summary
        uses: actions/upload-artifact@v3
        with:
          name: analysis-summary
          path: ANALYSIS-SUMMARY.md
